//Include wifi and mqtt needed libraries
#include <ESP8266WiFi.h>
#include <PubSubClient.h>

//define connection data for wifi and mqtt
const char* ssid = "HAN";
const char* password = "th1nkpad";
const char* mqtt_server = "172.16.2.170";
const int mqtt_port = 1883;
const char* TopicIn = "/Sufragerie/AC/commands";
const char* TopicOut = "/Sufragerie/AC/states";

WiFiClient ESPagbAC;

void setup() {
  
  Serial.begin(115200);
  delay(100);
  WiFi.begin(ssid, password);
  reconnect();
  delay(2000);
}

PubSubClient client(mqtt_server, mqtt_port, callback, ESPagbAC);

void loop() {
  
  //reconnect if connection is lost
  if (!client.connected() && WiFi.status() ==3) {reconnect();}

  //maintain MQTT connection
  client.loop();

  //delay for wifi functions to run
  delay(100);
}

void callback(char* topic, byte* payload, unsigned int lenght) {

  String topicStr = topic;

   if((char)payload[0] == 'O' && (char)payload[1] == 'N') {
    Serial.print("AC-ON");
    respond();  
    }

  if((char)payload[0] == 'O' && (char)payload[1] == 'F' && (char)payload[2] == 'F') {
    Serial.print("AC-OFF");
    respond();  
    }
}

void respond() {
  delay(6000);
  if (Serial.available()) {
    String ser = Serial.readString();
    if (ser == "ac-is-on") {
      client.publish(TopicOut, "ON");
      } else if (ser == "ac-is-off") {
        client.publish(TopicOut, "OFF");
     }  
  }
}

void reconnect() {
  if(WiFi.status() != WL_CONNECTED) {
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
    }
  }

if(WiFi.status() ==WL_CONNECTED) {
  while (!client.connected()) {
    String clientName;
    clientName += "ESPagbAC-";
    uint8_t mac[6];
    WiFi.macAddress(mac);
    clientName += macToStr(mac);

    if (client.connect((char*) clientName.c_str())) {
      Serial.print("\tMQTT Connected");
      client.subscribe(TopicIn);
    }
    else{Serial.println("\tFailed."); abort();}
  }
}
}

String macToStr(const uint8_t* mac) {
  String result;
  for (int i = 0; i < 6; ++i) {
    result += String(mac[i], 16);
    if (i < 5){
      result += ':';
    }
  }
  return result;
}